{{!-- templates/components/cart/page-title.html --}}
<div class="cart-header"
     style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:1rem;margin-bottom:1rem;">

  <h1 class="page-heading" data-cart-page-title
      style="grid-column:2;justify-self:center;text-align:center;">
    {{#if customer}}
      {{#if customer.customer_group_id "==" 10}}
        {{lang 'cart.quote_label' quantity=cart.quantity}}
      {{else}}
        {{lang 'cart.label' quantity=cart.quantity}}
      {{/if}}
    {{else}}
      {{lang 'cart.quote_label' quantity=cart.quantity}}
    {{/if}}
  </h1>

  {{#if cart.items.length}}
    <a
      href="#"
      role="button"
      class="button button--white"
      style="grid-column:3;justify-self:end;white-space:nowrap;"
      data-empty-entity="{{#if customer}}{{#if customer.customer_group_id '==' 10}}quote{{else}}cart{{/if}}{{else}}quote{{/if}}"
      aria-label="{{#if customer}}{{#if customer.customer_group_id '==' 10}}Empty quote{{else}}Empty cart{{/if}}{{else}}Empty quote{{/if}}">
      {{#if customer}}
        {{#if customer.customer_group_id "==" 10}}EMPTY QUOTE{{else}}EMPTY CART{{/if}}
      {{else}}
        EMPTY QUOTE
      {{/if}}
    </a>
  {{/if}}
</div>

<style>
/* Match your “white button” look, but let the theme control fonts */
.cart-header .button.button--white {
  background: #fff;
  color: #000;
  border: 1px solid currentColor;
  border-radius: 0;       /* squared corners */
  text-decoration: none;
}
.cart-header .button.button--white:hover { background: #f7f7f7; }
.cart-header .button.button--white:focus { outline: 2px solid #000; outline-offset: 2px; }
.cart-header .button.button--white[aria-busy="true"] { opacity: .65; pointer-events: none; }
</style>

<script>
/* Delegated click handler so it survives DOM re-renders */
(function () {
  function getXsrfToken() {
    var m = document.cookie.match(/(?:^|;)\s*XSRF-TOKEN=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  async function getActiveCartId() {
    const res = await fetch('/api/storefront/carts', { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Failed to load carts');
    const carts = await res.json();
    return Array.isArray(carts) && carts.length ? carts[0].id : null;
  }

  async function deleteCart(cartId) {
    const xsrf = getXsrfToken();
    const res = await fetch('/api/storefront/carts/' + cartId, {
      method: 'DELETE',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-XSRF-Token': xsrf || '',
        'XSRF-TOKEN': xsrf || ''
      }
    });
    if (!res.ok) throw new Error('Delete failed: ' + res.status);
  }

  document.addEventListener('click', async function (e) {
    const link = e.target.closest('.cart-header .button.button--white[data-empty-entity]');
    if (!link) return;

    e.preventDefault();

    const entity = (link.getAttribute('data-empty-entity') || 'cart').toLowerCase();
    const confirmMsg = entity === 'quote'
      ? 'Remove all items from your quote?'
      : 'Remove all items from your cart?';
    if (!confirm(confirmMsg)) return;

    const originalText = link.textContent;
    link.setAttribute('aria-busy', 'true');
    link.textContent = 'Emptying…';

    try {
      const cartId = await getActiveCartId();
      if (cartId) {
        await deleteCart(cartId);
      } else {
        location.reload();
        return;
      }
      location.href = '/cart.php';
    } catch (err) {
      console.error(err);
      alert('Sorry, we could not empty your ' + entity + '. Please try again.');
      link.removeAttribute('aria-busy');
      link.textContent = originalText;
    }
  });
})();
</script>
